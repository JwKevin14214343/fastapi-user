# ç‰ˆæœ¬æ›´æ–°è¯´æ˜ - JWTè®¤è¯ç‰ˆ

## ğŸ‰ é‡å¤§æ›´æ–°ï¼šv2.0 - JWTè®¤è¯ç³»ç»Ÿ

**æ›´æ–°æ—¥æœŸï¼š** 2024-12-16

---

## ğŸ“‹ æ›´æ–°å†…å®¹

### âœ… å·²å®ç°çš„åŠŸèƒ½

#### 1. **JWTè®¤è¯ç³»ç»Ÿ** ğŸ”
- ç”¨æˆ·æ³¨å†Œï¼š`POST /auth/register`
- ç”¨æˆ·ç™»å½•ï¼š`POST /auth/login`
- OAuth2æ”¯æŒï¼š`POST /auth/login/form`
- Tokenæœ‰æ•ˆæœŸï¼š24å°æ—¶ï¼ˆå¯é…ç½®ï¼‰

#### 2. **å¯†ç å®‰å…¨** ğŸ”’
- bcryptåŠ å¯†ç®—æ³•
- å¯†ç å“ˆå¸Œå­˜å‚¨
- å¯†ç ä¸å¯é€†åŠ å¯†

#### 3. **æ¥å£é‡æ„** ğŸ”„
- **ç§»é™¤**ï¼šæ‰€æœ‰ä½¿ç”¨`user_id`è·¯å¾„å‚æ•°çš„æ¥å£
- **æ–°å¢**ï¼šåŸºäºJWT tokençš„ç”¨æˆ·èº«ä»½è¯†åˆ«
- **æ”¹å˜**ï¼šä»`/users/{user_id}`æ”¹ä¸º`/users/me`

#### 4. **è´¦å·ç®¡ç†** ğŸ‘¤
- è´¦å·æ¿€æ´»/ç¦ç”¨çŠ¶æ€ï¼ˆ`is_active`å­—æ®µï¼‰
- åªèƒ½æ“ä½œè‡ªå·±çš„è´¦å·
- å¢å¼ºçš„å®‰å…¨æ€§

#### 5. **æ•°æ®åº“æ›´æ–°** ğŸ’¾
- æ–°å¢`password_hash`å­—æ®µ
- æ–°å¢`is_active`å­—æ®µ
- æ›´æ–°æ—¶é—´è‡ªåŠ¨ç®¡ç†

---

## ğŸ”„ æ¥å£å˜æ›´å¯¹ç…§è¡¨

### ç”¨æˆ·ç›¸å…³æ¥å£

| åŠŸèƒ½ | æ—§æ¥å£ | æ–°æ¥å£ | è®¤è¯ |
|------|--------|--------|------|
| åˆ›å»ºç”¨æˆ· | `POST /users/` | `POST /auth/register` | âŒ |
| ç”¨æˆ·ç™»å½• | âŒ ä¸å­˜åœ¨ | `POST /auth/login` | âŒ |
| è·å–ç”¨æˆ·ä¿¡æ¯ | `GET /users/{user_id}` | `GET /users/me` | âœ… |
| æ›´æ–°ç”¨æˆ·ä¿¡æ¯ | `PUT /users/{user_id}` | `PUT /users/me` | âœ… |
| åˆ é™¤ç”¨æˆ· | `DELETE /users/{user_id}` | `DELETE /users/me` | âœ… |

### ç®¡ç†æ¥å£

| åŠŸèƒ½ | æ—§æ¥å£ | æ–°æ¥å£ | è®¤è¯ |
|------|--------|--------|------|
| è·å–æ‰€æœ‰ç”¨æˆ· | `GET /users/` | `GET /users` | âœ… |
| æœç´¢ç”¨æˆ· | `GET /users/search/by-email` | `GET /users/search/by-email` | âœ… |
| ç”¨æˆ·ç»Ÿè®¡ | `GET /stats/count` | `GET /stats` | âœ… |

### ä¸»è¦åŒºåˆ«

#### âŒ æ—§ç‰ˆæœ¬ï¼ˆä¸å®‰å…¨ï¼‰
```bash
# ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®ä»»æ„ç”¨æˆ·çš„æ•°æ®
GET /users/1
GET /users/2
PUT /users/1  # å¯ä»¥ä¿®æ”¹åˆ«äººçš„æ•°æ®ï¼
```

#### âœ… æ–°ç‰ˆæœ¬ï¼ˆå®‰å…¨ï¼‰
```bash
# 1. å¿…é¡»å…ˆç™»å½•
POST /auth/login

# 2. è·å–tokenååªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
GET /users/me  # åªèƒ½çœ‹è‡ªå·±çš„ä¿¡æ¯
PUT /users/me  # åªèƒ½æ”¹è‡ªå·±çš„ä¿¡æ¯
```

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

```
fastapi-user/
â”œâ”€â”€ db/
â”‚   â””â”€â”€ auth.py                  # ğŸ†• JWTå’Œå¯†ç åŠ å¯†å·¥å…·
â”œâ”€â”€ schemas.py                   # ğŸ†• Pydanticæ¨¡å‹å®šä¹‰
â”œâ”€â”€ JWTè®¤è¯ä½¿ç”¨æŒ‡å—.md           # ğŸ†• JWTä½¿ç”¨æ–‡æ¡£
â””â”€â”€ ç‰ˆæœ¬æ›´æ–°è¯´æ˜-JWT.md          # ğŸ†• æœ¬æ–‡ä»¶
```

---

## ğŸ”§ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬å‡çº§

#### æ­¥éª¤1ï¼šå¤‡ä»½æ•°æ®ï¼ˆå¯é€‰ï¼‰
```bash
copy users.db users_backup.db
```

#### æ­¥éª¤2ï¼šå®‰è£…æ–°ä¾èµ–
```bash
cd fastapi-user-main
pip install -r requirements.txt
```

æ–°å¢çš„ä¾èµ–ï¼š
- `python-jose[cryptography]==3.3.0` - JWTå¤„ç†
- `passlib[bcrypt]==1.7.4` - å¯†ç åŠ å¯†
- `python-multipart==0.0.6` - è¡¨å•æ•°æ®å¤„ç†

#### æ­¥éª¤3ï¼šé‡å»ºæ•°æ®åº“
```bash
cd ..
python init_db.py
```

âš ï¸ **æ³¨æ„**ï¼šè¿™ä¼šåˆ é™¤æ—§æ•°æ®ï¼æ–°æ•°æ®åº“åŒ…å«æµ‹è¯•è´¦å·ã€‚

#### æ­¥éª¤4ï¼šå¯åŠ¨åº”ç”¨
```bash
cd fastapi-user-main
python main.py
```

#### æ­¥éª¤5ï¼šæµ‹è¯•
```bash
cd ..
python test_api.py
```

---

## ğŸ¯ ä»£ç ç¤ºä¾‹

### æ—§ç‰ˆæœ¬ä»£ç 

```python
import requests

# åˆ›å»ºç”¨æˆ·
response = requests.post("http://localhost:8000/users/", json={
    "name": "å¼ ä¸‰",
    "email": "test@example.com",
    "age": 25
})
user_id = response.json()["id"]

# è·å–ç”¨æˆ·
response = requests.get(f"http://localhost:8000/users/{user_id}")

# æ›´æ–°ç”¨æˆ·
response = requests.put(f"http://localhost:8000/users/{user_id}", json={
    "name": "å¼ ä¸‰ï¼ˆå·²æ›´æ–°ï¼‰"
})
```

### æ–°ç‰ˆæœ¬ä»£ç 

```python
import requests

# 1. æ³¨å†Œç”¨æˆ·
response = requests.post("http://localhost:8000/auth/register", json={
    "name": "å¼ ä¸‰",
    "email": "test@example.com",
    "password": "password123",  # æ–°å¢ï¼šéœ€è¦å¯†ç 
    "age": 25
})

# 2. ç™»å½•è·å–token
response = requests.post("http://localhost:8000/auth/login", json={
    "email": "test@example.com",
    "password": "password123"
})
token = response.json()["access_token"]

# 3. ä½¿ç”¨tokenè®¿é—®æ¥å£
headers = {"Authorization": f"Bearer {token}"}

# è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
response = requests.get("http://localhost:8000/users/me", headers=headers)

# æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
response = requests.put("http://localhost:8000/users/me", 
    json={"name": "å¼ ä¸‰ï¼ˆå·²æ›´æ–°ï¼‰"},
    headers=headers
)
```

---

## ğŸ”’ å®‰å…¨æ€§æå‡

| å®‰å…¨ç‰¹æ€§ | æ—§ç‰ˆæœ¬ | æ–°ç‰ˆæœ¬ |
|----------|--------|--------|
| å¯†ç å­˜å‚¨ | âŒ æ— å¯†ç  | âœ… bcryptåŠ å¯† |
| èº«ä»½éªŒè¯ | âŒ æ— éªŒè¯ | âœ… JWT Token |
| æƒé™æ§åˆ¶ | âŒ å¯è®¿é—®ä»»æ„ç”¨æˆ· | âœ… åªèƒ½è®¿é—®è‡ªå·± |
| æ•°æ®ä¿æŠ¤ | âŒ ä»»ä½•äººå¯ä¿®æ”¹ | âœ… ä»…æœ¬äººå¯ä¿®æ”¹ |
| Tokenç­¾å | âŒ æ—  | âœ… HMAC-SHA256 |
| Tokenè¿‡æœŸ | âŒ æ—  | âœ… 24å°æ—¶è‡ªåŠ¨è¿‡æœŸ |

---

## ğŸ“š æ–‡æ¡£èµ„æº

1. **å¿«é€Ÿå¼€å§‹**ï¼šé˜…è¯» `JWTè®¤è¯ä½¿ç”¨æŒ‡å—.md`
2. **APIæ–‡æ¡£**ï¼šè®¿é—® http://127.0.0.1:8000/docs
3. **æµ‹è¯•è„šæœ¬**ï¼šè¿è¡Œ `python test_api.py`
4. **åˆå§‹åŒ–æ•°æ®åº“**ï¼šè¿è¡Œ `python init_db.py`

---

## âš™ï¸ é…ç½®è¯´æ˜

### JWTé…ç½®ï¼ˆ`db/auth.py`ï¼‰

```python
# Secret Keyï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»æ›´æ¢ï¼ï¼‰
SECRET_KEY = "your-secret-key-here..."

# åŠ å¯†ç®—æ³•
ALGORITHM = "HS256"

# Tokenæœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24  # 24å°æ—¶
```

### ä¿®æ”¹Tokenæœ‰æ•ˆæœŸ

```python
# æ”¹ä¸º7å¤©
ACCESS_TOKEN_EXPIRE_MINUTES = 60 * 24 * 7

# æ”¹ä¸º1å°æ—¶
ACCESS_TOKEN_EXPIRE_MINUTES = 60
```

---

## ğŸ§ª æµ‹è¯•è´¦å·

è¿è¡Œ `python init_db.py` åä¼šåˆ›å»ºä»¥ä¸‹æµ‹è¯•è´¦å·ï¼š

| å§“å | é‚®ç®± | å¯†ç  | çŠ¶æ€ |
|------|------|------|------|
| å¼ ä¸‰ | zhangsan@example.com | password123 | âœ… æ¿€æ´» |
| æå›› | lisi@example.com | password123 | âœ… æ¿€æ´» |
| ç‹äº” | wangwu@example.com | password123 | âœ… æ¿€æ´» |
| èµµå…­ | zhaoliu@example.com | password123 | âŒ ç¦ç”¨ |

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åœ¨Swagger UIä¸­ä½¿ç”¨JWTè®¤è¯ï¼Ÿ

**æ­¥éª¤ï¼š**
1. è®¿é—® http://127.0.0.1:8000/docs
2. ç‚¹å‡»å³ä¸Šè§’çš„"Authorize" ğŸ”“ æŒ‰é’®
3. è¾“å…¥é‚®ç®±ï¼ˆusernameï¼‰å’Œå¯†ç 
4. ç‚¹å‡»"Authorize"
5. ç°åœ¨å¯ä»¥æµ‹è¯•æ‰€æœ‰éœ€è¦è®¤è¯çš„æ¥å£

### Q2: æ—§ç‰ˆæœ¬çš„APIè¿˜èƒ½ç”¨å—ï¼Ÿ

âŒ **ä¸èƒ½**ã€‚æ‰€æœ‰ä½¿ç”¨`/users/{user_id}`çš„æ¥å£å·²è¢«ç§»é™¤ã€‚

### Q3: Tokenè¿‡æœŸåæ€ä¹ˆåŠï¼Ÿ

é‡æ–°ç™»å½•è·å–æ–°tokenï¼š
```python
response = requests.post("http://localhost:8000/auth/login", json={...})
new_token = response.json()["access_token"]
```

### Q4: å¦‚ä½•æŸ¥çœ‹Tokenå†…å®¹ï¼Ÿ

è®¿é—® https://jwt.io/ å¹¶ç²˜è´´tokenå³å¯è§£ç æŸ¥çœ‹ã€‚

### Q5: ç”Ÿäº§ç¯å¢ƒéœ€è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ

âš ï¸ **é‡è¦**ï¼š
1. ä¿®æ”¹ `SECRET_KEY`ï¼ˆå¿…é¡»ï¼ï¼‰
2. ä½¿ç”¨HTTPSï¼ˆå¿…é¡»ï¼ï¼‰
3. å®šæœŸæ›´æ¢å¯†é’¥
4. æ·»åŠ ç®¡ç†å‘˜æƒé™ç³»ç»Ÿ
5. å®ç°å¯†ç æ‰¾å›åŠŸèƒ½
6. æ·»åŠ æ—¥å¿—è®°å½•
7. é…ç½®CORS

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. âœ… **å®‰å…¨æ€§**ï¼šä»æ— è®¤è¯åˆ°JWTè®¤è¯
2. âœ… **éšç§æ€§**ï¼šåªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
3. âœ… **æ ‡å‡†åŒ–**ï¼šä½¿ç”¨OAuth2æ ‡å‡†
4. âœ… **ç”Ÿäº§å°±ç»ª**ï¼šå¯ç”¨äºå®é™…é¡¹ç›®

### ä¸‹ä¸€æ­¥å»ºè®®

- ğŸ” æ·»åŠ è§’è‰²å’Œæƒé™ç³»ç»Ÿï¼ˆadmin/userï¼‰
- ğŸ“§ å®ç°é‚®ä»¶æ‰¾å›å¯†ç 
- ğŸ”„ å®ç°åˆ·æ–°Tokenæœºåˆ¶
- ğŸ“ æ·»åŠ æ“ä½œæ—¥å¿—
- ğŸ›¡ï¸ æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶

---

**ç‰ˆæœ¬ï¼š** v2.0 JWTè®¤è¯ç‰ˆ
**ä½œè€…ï¼š** AI Assistant
**æ›´æ–°æ—¥æœŸï¼š** 2024-12-16

ğŸ‰ **äº«å—æ›´å®‰å…¨çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼**

