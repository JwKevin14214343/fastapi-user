# æ•°æ®åº“ç‰ˆæœ¬è¯´æ˜

## ğŸ“‹ ç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | å†…å­˜ç‰ˆæœ¬ | æ•°æ®åº“ç‰ˆæœ¬ï¼ˆå½“å‰ï¼‰ |
|------|----------|-------------------|
| æ•°æ®å­˜å‚¨ | Pythonå­—å…¸ï¼ˆå†…å­˜ï¼‰ | SQLiteæ•°æ®åº“æ–‡ä»¶ |
| æ•°æ®æŒä¹…åŒ– | âŒ é‡å¯ä¸¢å¤± | âœ… æ°¸ä¹…ä¿å­˜ |
| å¹¶å‘å®‰å…¨ | âš ï¸ æœ‰é™ | âœ… æ”¯æŒ |
| æ•°æ®æŸ¥è¯¢ | ç®€å•éå† | âœ… SQLä¼˜åŒ–æŸ¥è¯¢ |
| ç´¢å¼•æ”¯æŒ | âŒ æ—  | âœ… emailå­—æ®µç´¢å¼• |
| åˆ†é¡µæŸ¥è¯¢ | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒ |
| æ—¶é—´æˆ³ | æ‰‹åŠ¨è®¾ç½® | âœ… è‡ªåŠ¨ç®¡ç† |
| æ•°æ®å¤‡ä»½ | âŒ å›°éš¾ | âœ… å¤åˆ¶dbæ–‡ä»¶ |
| ç”Ÿäº§å°±ç»ª | âŒ ä»…ç”¨äºæµ‹è¯• | âœ… å¯ç”¨äºç”Ÿäº§ |

## ğŸ†• æ–°å¢å†…å®¹

### 1. æ•°æ®åº“æ¨¡å— (`db/`)

```
db/
â”œâ”€â”€ __init__.py      # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ database.py      # æ•°æ®åº“è¿æ¥å’Œé…ç½®
â””â”€â”€ model.py         # ORMæ•°æ®æ¨¡å‹
```

**database.py** - æ•°æ®åº“è¿æ¥
- SQLAlchemyå¼•æ“é…ç½®
- ä¼šè¯ç®¡ç†
- ä¾èµ–æ³¨å…¥å‡½æ•°

**model.py** - æ•°æ®æ¨¡å‹
- UserModel ORMç±»
- è¡¨ç»“æ„å®šä¹‰
- å­—æ®µçº¦æŸå’Œç´¢å¼•

### 2. æ–°å¢è„šæœ¬

**init_db.py** - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
- åˆ›å»ºè¡¨ç»“æ„
- æ’å…¥æµ‹è¯•æ•°æ®
- æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå¯é€‰ï¼‰

### 3. æ–°å¢APIæ¥å£

**GET /stats/count** - è·å–ç”¨æˆ·ç»Ÿè®¡
```json
{
  "total_users": 10
}
```

### 4. å¢å¼ºåŠŸèƒ½

**åˆ†é¡µæŸ¥è¯¢** - è·å–ç”¨æˆ·åˆ—è¡¨
```
GET /users/?skip=0&limit=10
```

**è‡ªåŠ¨æ—¶é—´æˆ³** - æ–°å¢å­—æ®µ
- `created_at`: åˆ›å»ºæ—¶é—´ï¼ˆè‡ªåŠ¨ï¼‰
- `updated_at`: æ›´æ–°æ—¶é—´ï¼ˆè‡ªåŠ¨ï¼‰

## ğŸ”„ ä¸»è¦ä»£ç å˜åŒ–

### main.py å˜åŒ–

#### ä¹‹å‰ï¼ˆå†…å­˜ç‰ˆæœ¬ï¼‰ï¼š
```python
# å…¨å±€å˜é‡å­˜å‚¨
users_db: Dict[int, User] = {}
next_user_id = 1

@app.post("/users/")
def create_user(user: UserCreate):
    global next_user_id
    new_user = User(
        id=next_user_id,
        name=user.name,
        email=user.email,
        age=user.age,
        created_at=datetime.now()
    )
    users_db[next_user_id] = new_user
    next_user_id += 1
    return new_user
```

#### ç°åœ¨ï¼ˆæ•°æ®åº“ç‰ˆæœ¬ï¼‰ï¼š
```python
# ä½¿ç”¨ä¾èµ–æ³¨å…¥è·å–æ•°æ®åº“ä¼šè¯
@app.post("/users/")
def create_user(user: UserCreate, db: Session = Depends(get_db)):
    db_user = UserModel(
        name=user.name,
        email=user.email,
        age=user.age
    )
    db.add(db_user)
    db.commit()
    db.refresh(db_user)
    return db_user
```

### å…³é”®æ”¹è¿›

1. **ä¾èµ–æ³¨å…¥** - `db: Session = Depends(get_db)`
   - è‡ªåŠ¨ç®¡ç†æ•°æ®åº“ä¼šè¯
   - è‡ªåŠ¨å…³é—­è¿æ¥
   - å¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š

2. **ORMæ“ä½œ** - é¢å‘å¯¹è±¡çš„æ•°æ®åº“æ“ä½œ
   ```python
   # æŸ¥è¯¢
   user = db.query(UserModel).filter(UserModel.id == user_id).first()
   
   # æ·»åŠ 
   db.add(db_user)
   db.commit()
   
   # æ›´æ–°
   user.name = "æ–°åå­—"
   db.commit()
   
   # åˆ é™¤
   db.delete(user)
   db.commit()
   ```

3. **æ•°æ®éªŒè¯** - æ•°æ®åº“çº§åˆ«çº¦æŸ
   - UNIQUEçº¦æŸï¼ˆé‚®ç®±å”¯ä¸€ï¼‰
   - NOT NULLçº¦æŸï¼ˆå¿…å¡«å­—æ®µï¼‰
   - ç´¢å¼•ä¼˜åŒ–ï¼ˆæŸ¥è¯¢æ€§èƒ½ï¼‰

## ğŸ“¦ ä¾èµ–å˜åŒ–

### requirements.txt

```diff
  # Python 3.11
  fastapi==0.109.0
  uvicorn[standard]==0.27.0
  pydantic[email]==2.5.3
  requests==2.31.0
+ sqlalchemy==2.0.30
```

## ğŸ—ƒï¸ æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    age INTEGER,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX ix_users_email ON users(email);
CREATE INDEX ix_users_id ON users(id);
```

## ğŸ¯ ä½¿ç”¨å»ºè®®

### å¼€å‘ç¯å¢ƒ
âœ… **ä½¿ç”¨SQLite**ï¼ˆå½“å‰é…ç½®ï¼‰
- æ— éœ€å®‰è£…é¢å¤–è½¯ä»¶
- é…ç½®ç®€å•
- é€‚åˆæœ¬åœ°å¼€å‘å’Œæµ‹è¯•

### ç”Ÿäº§ç¯å¢ƒ
ğŸš€ **æ¨èPostgreSQLæˆ–MySQL**

**PostgreSQLé…ç½®ç¤ºä¾‹ï¼š**
```python
# db/database.py
SQLALCHEMY_DATABASE_URL = "postgresql://username:password@localhost:5432/dbname"
engine = create_engine(SQLALCHEMY_DATABASE_URL)
```

éœ€è¦å®‰è£…ï¼š
```bash
pip install psycopg2-binary
```

**MySQLé…ç½®ç¤ºä¾‹ï¼š**
```python
# db/database.py
SQLALCHEMY_DATABASE_URL = "mysql+pymysql://username:password@localhost:3306/dbname"
engine = create_engine(SQLALCHEMY_DATABASE_URL)
```

éœ€è¦å®‰è£…ï¼š
```bash
pip install pymysql
```

## ğŸ”’ æ•°æ®å®‰å…¨

### å¤‡ä»½æ•°æ®åº“

**SQLiteï¼š**
```bash
# å¤åˆ¶æ•°æ®åº“æ–‡ä»¶
copy users.db users_backup.db
```

**å¯¼å‡ºSQLï¼š**
```bash
sqlite3 users.db .dump > backup.sql
```

**æ¢å¤ï¼š**
```bash
sqlite3 users.db < backup.sql
```

### æ•°æ®è¿ç§»

å¦‚æœéœ€è¦ä»SQLiteè¿ç§»åˆ°å…¶ä»–æ•°æ®åº“ï¼š

1. å¯¼å‡ºæ•°æ®
2. ä¿®æ”¹ `database.py` ä¸­çš„è¿æ¥å­—ç¬¦ä¸²
3. è¿è¡Œ `Base.metadata.create_all(bind=engine)` åˆ›å»ºè¡¨
4. å¯¼å…¥æ•°æ®

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°çš„ä¼˜åŒ–

1. **ç´¢å¼•** - emailå’Œidå­—æ®µå·²å»ºç«‹ç´¢å¼•
2. **åˆ†é¡µ** - æ”¯æŒskip/limitå‚æ•°
3. **ä¼šè¯ç®¡ç†** - è‡ªåŠ¨å…³é—­æ•°æ®åº“è¿æ¥
4. **è¿æ¥æ± ** - SQLAlchemyè‡ªåŠ¨ç®¡ç†

### è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æŸ¥è¯¢ä¼˜åŒ–**
   ```python
   # åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
   db.query(UserModel.id, UserModel.name).all()
   ```

2. **æ‰¹é‡æ“ä½œ**
   ```python
   # æ‰¹é‡æ’å…¥
   db.bulk_insert_mappings(UserModel, user_list)
   ```

3. **ç¼“å­˜** - æ·»åŠ Redisç¼“å­˜çƒ­é—¨æŸ¥è¯¢

4. **å¼‚æ­¥** - ä½¿ç”¨å¼‚æ­¥SQLAlchemyï¼ˆé€‚åˆé«˜å¹¶å‘ï¼‰

## ğŸ§ª æµ‹è¯•æ•°æ®

è¿è¡Œ `python init_db.py` ä¼šåˆ›å»ºï¼š

| ID | å§“å | é‚®ç®± | å¹´é¾„ |
|----|------|------|------|
| 1 | å¼ ä¸‰ | zhangsan@example.com | 25 |
| 2 | æå›› | lisi@example.com | 30 |
| 3 | ç‹äº” | wangwu@example.com | 28 |
| 4 | èµµå…­ | zhaoliu@example.com | 35 |

## ğŸ“ å­¦ä¹ èµ„æº

- **SQLAlchemyæ•™ç¨‹**ï¼šhttps://docs.sqlalchemy.org/en/20/tutorial/
- **FastAPIæ•°æ®åº“**ï¼šhttps://fastapi.tiangolo.com/tutorial/sql-databases/
- **SQLiteæ–‡æ¡£**ï¼šhttps://www.sqlite.org/docs.html

---

**ç‰ˆæœ¬ï¼š** æ•°æ®åº“ç‰ˆæœ¬ v1.0
**æ›´æ–°æ—¥æœŸï¼š** 2024-12-15

