<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ - æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .auth-status {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .auth-status.logged-in {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }

        .auth-status.logged-out {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #5a6268;
        }

        button.danger {
            background: #dc3545;
        }

        button.danger:hover {
            background: #c82333;
        }

        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .output.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .full-width-card {
            grid-column: 1 / -1;
        }

        .user-item {
            background: #f8f9fa;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge.active {
            background: #28a745;
            color: white;
        }

        .badge.inactive {
            background: #dc3545;
            color: white;
        }

        .config {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .config input {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-right: 10px;
            width: 300px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ç”¨æˆ·ç®¡ç†ç³»ç»Ÿæµ‹è¯•é¡µé¢</h1>
            <p>åŸºäº FastAPI + JWT è®¤è¯</p>
        </div>

        <!-- APIé…ç½® -->
        <div class="config">
            <label><strong>API åœ°å€ï¼š</strong></label>
            <input type="text" id="apiBase" value="http://127.0.0.1:8000">
            <button onclick="updateApiBase()" style="width: auto; padding: 8px 16px;">æ›´æ–°</button>
        </div>

        <!-- è®¤è¯çŠ¶æ€ -->
        <div class="auth-status" id="authStatus">
            <strong>çŠ¶æ€ï¼š</strong><span id="statusText">æœªç™»å½•</span>
            <span id="userInfo"></span>
            <button onclick="logout()" id="logoutBtn" style="display: none; width: auto; float: right; padding: 8px 16px;">é€€å‡ºç™»å½•</button>
        </div>

        <!-- ä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
        <div class="grid">
            <!-- ç”¨æˆ·æ³¨å†Œ -->
            <div class="card">
                <h2>ğŸ“ ç”¨æˆ·æ³¨å†Œ</h2>
                <div class="form-group">
                    <label>å§“å</label>
                    <input type="text" id="regName" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="regEmail" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="regPassword" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦">
                </div>
                <div class="form-group">
                    <label>å¹´é¾„ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="number" id="regAge" placeholder="è¯·è¾“å…¥å¹´é¾„">
                </div>
                <button onclick="register()">æ³¨å†Œ</button>
                <div class="output" id="regOutput"></div>
            </div>

            <!-- ç”¨æˆ·ç™»å½• -->
            <div class="card">
                <h2>ğŸ” ç”¨æˆ·ç™»å½•</h2>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="loginEmail" placeholder="example@email.com">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button onclick="login()">ç™»å½•</button>
                <div class="output" id="loginOutput"></div>
            </div>

            <!-- è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
            <div class="card">
                <h2>ğŸ‘¤ æˆ‘çš„ä¿¡æ¯</h2>
                <button onclick="getCurrentUser()">è·å–æˆ‘çš„ä¿¡æ¯</button>
                <div class="output" id="currentUserOutput"></div>
            </div>

            <!-- æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯ -->
            <div class="card">
                <h2>âœï¸ æ›´æ–°æˆ‘çš„ä¿¡æ¯</h2>
                <div class="form-group">
                    <label>æ–°å§“åï¼ˆå¯é€‰ï¼‰</label>
                    <input type="text" id="updateName" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                </div>
                <div class="form-group">
                    <label>æ–°é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="email" id="updateEmail" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                </div>
                <div class="form-group">
                    <label>æ–°å¹´é¾„ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="number" id="updateAge" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                </div>
                <div class="form-group">
                    <label>æ–°å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="password" id="updatePassword" placeholder="ç•™ç©ºåˆ™ä¸ä¿®æ”¹">
                </div>
                <button onclick="updateCurrentUser()">æ›´æ–°ä¿¡æ¯</button>
                <div class="output" id="updateOutput"></div>
            </div>

            <!-- åˆ é™¤å½“å‰ç”¨æˆ· -->
            <div class="card">
                <h2>ğŸ—‘ï¸ åˆ é™¤è´¦å·</h2>
                <p style="color: #dc3545; margin-bottom: 15px;">âš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼</p>
                <button class="danger" onclick="deleteCurrentUser()">åˆ é™¤æˆ‘çš„è´¦å·</button>
                <div class="output" id="deleteOutput"></div>
            </div>

            <!-- æœç´¢ç”¨æˆ· -->
            <div class="card">
                <h2>ğŸ” æœç´¢ç”¨æˆ·</h2>
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="searchEmail" placeholder="è¾“å…¥è¦æœç´¢çš„é‚®ç®±">
                </div>
                <button onclick="searchUserByEmail()">æœç´¢</button>
                <div class="output" id="searchOutput"></div>
            </div>
        </div>

        <!-- å…¨å®½å¡ç‰‡ -->
        <div class="grid">
            <!-- è·å–æ‰€æœ‰ç”¨æˆ· -->
            <div class="card full-width-card">
                <h2>ğŸ‘¥ æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="number" id="userSkip" placeholder="è·³è¿‡è®°å½•æ•°" value="0" style="width: 150px; padding: 8px;">
                    <input type="number" id="userLimit" placeholder="é™åˆ¶è®°å½•æ•°" value="10" style="width: 150px; padding: 8px;">
                    <button onclick="getAllUsers()" style="width: auto; padding: 8px 24px;">è·å–ç”¨æˆ·åˆ—è¡¨</button>
                </div>
                <div class="output" id="usersOutput"></div>
            </div>

            <!-- ç”¨æˆ·ç»Ÿè®¡ -->
            <div class="card full-width-card">
                <h2>ğŸ“Š ç”¨æˆ·ç»Ÿè®¡</h2>
                <button onclick="getUserStats()">è·å–ç»Ÿè®¡ä¿¡æ¯</button>
                <div id="statsOutput"></div>
            </div>
        </div>
    </div>

    <script>
        // APIåŸºç¡€åœ°å€
        let API_BASE = 'http://127.0.0.1:8000';

        // è·å–token
        function getToken() {
            return localStorage.getItem('token');
        }

        // ä¿å­˜token
        function saveToken(token) {
            localStorage.setItem('token', token);
            updateAuthStatus();
        }

        // æ¸…é™¤token
        function clearToken() {
            localStorage.removeItem('token');
            updateAuthStatus();
        }

        // æ›´æ–°APIåŸºç¡€åœ°å€
        function updateApiBase() {
            API_BASE = document.getElementById('apiBase').value;
            alert('APIåœ°å€å·²æ›´æ–°ä¸º: ' + API_BASE);
        }

        // æ›´æ–°è®¤è¯çŠ¶æ€æ˜¾ç¤º
        function updateAuthStatus() {
            const token = getToken();
            const statusDiv = document.getElementById('authStatus');
            const statusText = document.getElementById('statusText');
            const userInfo = document.getElementById('userInfo');
            const logoutBtn = document.getElementById('logoutBtn');

            if (token) {
                statusDiv.className = 'auth-status logged-in';
                statusText.textContent = 'âœ… å·²ç™»å½•';
                userInfo.textContent = ' (Tokenå·²ä¿å­˜)';
                logoutBtn.style.display = 'inline-block';
            } else {
                statusDiv.className = 'auth-status logged-out';
                statusText.textContent = 'âŒ æœªç™»å½•';
                userInfo.textContent = '';
                logoutBtn.style.display = 'none';
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                clearToken();
                alert('å·²é€€å‡ºç™»å½•');
            }
        }

        // å‘èµ·APIè¯·æ±‚
        async function apiRequest(url, method = 'GET', data = null, requireAuth = false) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (requireAuth) {
                const token = getToken();
                if (!token) {
                    throw new Error('æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•è·å–token');
                }
                options.headers['Authorization'] = `Bearer ${token}`;
            }

            if (data) {
                options.body = JSON.stringify(data);
            }

            const response = await fetch(`${API_BASE}${url}`, options);
            
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'è¯·æ±‚å¤±è´¥');
            }

            if (response.status === 204) {
                return null;
            }

            return await response.json();
        }

        // æ˜¾ç¤ºè¾“å‡º
        function showOutput(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.className = 'output ' + (isError ? 'error' : 'success');
            element.textContent = typeof content === 'string' ? content : JSON.stringify(content, null, 2);
        }

        // ========== ç”¨æˆ·æ³¨å†Œ ==========
        async function register() {
            try {
                const name = document.getElementById('regName').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const age = document.getElementById('regAge').value;

                if (!name || !email || !password) {
                    throw new Error('è¯·å¡«å†™å§“åã€é‚®ç®±å’Œå¯†ç ');
                }

                const data = { name, email, password };
                if (age) data.age = parseInt(age);

                const result = await apiRequest('/auth/register', 'POST', data);
                showOutput('regOutput', 'âœ… æ³¨å†ŒæˆåŠŸï¼\n' + JSON.stringify(result, null, 2));
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('regName').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regAge').value = '';
            } catch (error) {
                showOutput('regOutput', 'âŒ æ³¨å†Œå¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== ç”¨æˆ·ç™»å½• ==========
        async function login() {
            try {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                if (!email || !password) {
                    throw new Error('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ');
                }

                const result = await apiRequest('/auth/login', 'POST', { email, password });
                
                // ä¿å­˜token
                saveToken(result.access_token);
                
                showOutput('loginOutput', 'âœ… ç™»å½•æˆåŠŸï¼\n\nç”¨æˆ·ä¿¡æ¯ï¼š\n' + JSON.stringify(result.user, null, 2) + '\n\nTokenå·²è‡ªåŠ¨ä¿å­˜åˆ° localStorage');
            } catch (error) {
                showOutput('loginOutput', 'âŒ ç™»å½•å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ ==========
        async function getCurrentUser() {
            try {
                const result = await apiRequest('/users/me', 'GET', null, true);
                showOutput('currentUserOutput', 'âœ… è·å–æˆåŠŸï¼\n' + JSON.stringify(result, null, 2));
            } catch (error) {
                showOutput('currentUserOutput', 'âŒ è·å–å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯ ==========
        async function updateCurrentUser() {
            try {
                const name = document.getElementById('updateName').value;
                const email = document.getElementById('updateEmail').value;
                const age = document.getElementById('updateAge').value;
                const password = document.getElementById('updatePassword').value;

                const data = {};
                if (name) data.name = name;
                if (email) data.email = email;
                if (age) data.age = parseInt(age);
                if (password) data.password = password;

                if (Object.keys(data).length === 0) {
                    throw new Error('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªè¦æ›´æ–°çš„å­—æ®µ');
                }

                const result = await apiRequest('/users/me', 'PUT', data, true);
                showOutput('updateOutput', 'âœ… æ›´æ–°æˆåŠŸï¼\n' + JSON.stringify(result, null, 2));
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('updateName').value = '';
                document.getElementById('updateEmail').value = '';
                document.getElementById('updateAge').value = '';
                document.getElementById('updatePassword').value = '';
            } catch (error) {
                showOutput('updateOutput', 'âŒ æ›´æ–°å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== åˆ é™¤å½“å‰ç”¨æˆ· ==========
        async function deleteCurrentUser() {
            if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤æ‚¨çš„è´¦å·å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }

            try {
                await apiRequest('/users/me', 'DELETE', null, true);
                showOutput('deleteOutput', 'âœ… è´¦å·å·²åˆ é™¤');
                clearToken();
            } catch (error) {
                showOutput('deleteOutput', 'âŒ åˆ é™¤å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== è·å–æ‰€æœ‰ç”¨æˆ· ==========
        async function getAllUsers() {
            try {
                const skip = document.getElementById('userSkip').value || 0;
                const limit = document.getElementById('userLimit').value || 10;
                
                const result = await apiRequest(`/users?skip=${skip}&limit=${limit}`, 'GET', null, true);
                
                let output = `âœ… è·å–æˆåŠŸï¼å…± ${result.length} æ¡è®°å½•\n\n`;
                result.forEach((user, index) => {
                    output += `ã€ç”¨æˆ· ${index + 1}ã€‘\n`;
                    output += `  ID: ${user.id}\n`;
                    output += `  å§“å: ${user.name}\n`;
                    output += `  é‚®ç®±: ${user.email}\n`;
                    output += `  å¹´é¾„: ${user.age || 'æœªè®¾ç½®'}\n`;
                    output += `  çŠ¶æ€: ${user.is_active ? 'âœ… æ´»è·ƒ' : 'âŒ ç¦ç”¨'}\n`;
                    output += `  åˆ›å»ºæ—¶é—´: ${user.created_at}\n`;
                    output += `\n`;
                });
                
                showOutput('usersOutput', output);
            } catch (error) {
                showOutput('usersOutput', 'âŒ è·å–å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== æœç´¢ç”¨æˆ· ==========
        async function searchUserByEmail() {
            try {
                const email = document.getElementById('searchEmail').value;
                
                if (!email) {
                    throw new Error('è¯·è¾“å…¥è¦æœç´¢çš„é‚®ç®±');
                }
                
                const result = await apiRequest(`/users/search/by-email?email=${encodeURIComponent(email)}`, 'GET', null, true);
                showOutput('searchOutput', 'âœ… æ‰¾åˆ°ç”¨æˆ·ï¼\n' + JSON.stringify(result, null, 2));
            } catch (error) {
                showOutput('searchOutput', 'âŒ æœç´¢å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // ========== è·å–ç”¨æˆ·ç»Ÿè®¡ ==========
        async function getUserStats() {
            try {
                const result = await apiRequest('/stats', 'GET', null, true);
                
                const statsDiv = document.getElementById('statsOutput');
                statsDiv.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="number">${result.total_users}</div>
                            <div class="label">æ€»ç”¨æˆ·æ•°</div>
                        </div>
                        <div class="stat-box">
                            <div class="number">${result.active_users}</div>
                            <div class="label">æ´»è·ƒç”¨æˆ·</div>
                        </div>
                        <div class="stat-box">
                            <div class="number">${result.inactive_users}</div>
                            <div class="label">ç¦ç”¨ç”¨æˆ·</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                showOutput('statsOutput', 'âŒ è·å–å¤±è´¥ï¼š' + error.message, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ›´æ–°è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            updateAuthStatus();
        });
    </script>
</body>
</html>

